name: Branch Based CI/CD

on:
  push:
    branches:
      - amari-capital
      - Broker

jobs:
  ci:
    name: Run Tests & Build
    runs-on: ubuntu-latest

    outputs:
      deploy_path: ${{ steps.set-path.outputs.deploy_path }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set deploy path based on branch
      id: set-path
      run: |
        if [[ "${GITHUB_REF_NAME}" == "amari-capital" ]]; then
          echo "deploy_path=C:/xampp/htdocs/amari-capital/" >> $GITHUB_OUTPUT
        elif [[ "${GITHUB_REF_NAME}" == "Broker" ]]; then
          echo "deploy_path=C:/xampp/htdocs/broker/" >> $GITHUB_OUTPUT
        fi

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run lint
      run: npm run lint

    - name: Run tests
      run: npm test

    - name: Build project
      run: npm run build

    - name: Upload dist artifact
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist

  cd:
    name: Deploy to Windows XAMPP
    needs: ci
    runs-on: ubuntu-latest

    steps:
    - name: Download dist artifact
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist

    - name: Deploy dist to correct folder
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.WINDOWS_HOST }}
        username: ${{ secrets.WINDOWS_USER }}
        password: ${{ secrets.WINDOWS_PASSWORD }}
        source: "dist/*"
        target: ${{ needs.ci.outputs.deploy_path }}
